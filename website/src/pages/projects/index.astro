---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/Base.astro';

// Get all projects
const allProjects = await getCollection('projects');

// Define major project slugs
const majorProjectSlugs = ['delight', 'magk-excel', 'efficore', 'arkos'];

// Process and sort projects
const processedProjects = allProjects
  .map(project => {
    const startDate = new Date(project.data.startDate);
    const endDate = project.data.endDate ? new Date(project.data.endDate) : null;

    return {
      ...project,
      duration: endDate
        ? `${startDate.getFullYear()} - ${endDate.getFullYear()}`
        : `${startDate.getFullYear()} - Present`,
      startDateObj: startDate,
    };
  })
  .sort((a, b) => b.startDateObj.getTime() - a.startDateObj.getTime());

// Split into major and minor projects
const majorProjects = processedProjects.filter(p => majorProjectSlugs.includes(p.slug));
const minorProjects = processedProjects.filter(p => !majorProjectSlugs.includes(p.slug));
---

<BaseLayout
  title="Projects - Jack Luo"
  description="Projects, experiments, and ventures across AI, energy, security, and community."
  currentPage="projects"
>
  <section id="projects-section">
    <div class="projects-scroll-container">
      <div class="container-fluid">
        <!-- Page Title -->
        <div class="row">
          <div class="col-12">
            <div class="projects-page-header">
              <h1>Projects</h1>
              <p class="projects-subtitle">Building across AI agents and software to improve and impact the world</p>
            </div>
          </div>
        </div>

        <!-- Major Projects -->
        <div class="section-header">
          <h2>Major Projects</h2>
        </div>
        <div class="row projects-grid major-grid">
          {majorProjects.map((project) => (
            <div class="col-12 col-md-6">
              <article class="project-card major-card" data-project-slug={project.slug}>
                {project.data.gallery && project.data.gallery.length > 0 && project.data.gallery[0].src && (
                  <img
                    src={project.data.gallery[0].src}
                    alt={project.data.gallery[0].alt}
                    class="project-image"
                  />
                )}

                <div class="project-card-content">
                  <div class="project-card-header">
                    <h3 class="project-title">{project.data.title}</h3>
                    <div class="project-badges">
                      {project.data.featured && (
                        <span class="badge-featured">Featured</span>
                      )}
                      {project.data.status && (
                        <span class={`badge-status status-${project.data.status.toLowerCase()}`}>
                          {project.data.status}
                        </span>
                      )}
                    </div>
                  </div>

                  <p class="project-role">{project.data.role}</p>
                  <p class="project-summary">{project.data.summary}</p>

                  <div class="project-meta">
                    <span class="project-category">{project.data.category}</span>
                    <span class="meta-separator">â€¢</span>
                    <span class="project-duration">{project.duration}</span>
                  </div>

                  <div class="project-tech">
                    {project.data.tech.slice(0, 4).map(tech => (
                      <span class="tech-tag">{tech}</span>
                    ))}
                    {project.data.tech.length > 4 && (
                      <span class="tech-more">+{project.data.tech.length - 4}</span>
                    )}
                  </div>
                </div>
              </article>
            </div>
          ))}
        </div>

        <!-- Minor Projects -->
        {minorProjects.length > 0 && (
          <>
            <div class="section-header minor-header">
              <h2>Experiments & Archive</h2>
            </div>
            <div class="row projects-grid minor-grid">
              {minorProjects.map((project) => (
                <div class="col-12 col-md-4">
                  <article class="project-card minor-card" data-project-slug={project.slug}>
                    {project.data.gallery && project.data.gallery.length > 0 && project.data.gallery[0].src && (
                      <img
                        src={project.data.gallery[0].src}
                        alt={project.data.gallery[0].alt}
                        class="project-image minor-image"
                      />
                    )}

                    <div class="project-card-content">
                      <div class="project-card-header">
                        <h3 class="project-title minor-title">{project.data.title}</h3>
                      </div>

                      <p class="project-role minor-role">{project.data.role}</p>

                      <div class="project-meta">
                        <span class="project-duration">{project.duration}</span>
                      </div>

                      <div class="project-tech">
                        {project.data.tech.slice(0, 3).map(tech => (
                          <span class="tech-tag minor-tech-tag">{tech}</span>
                        ))}
                        {project.data.tech.length > 3 && (
                          <span class="tech-more">+{project.data.tech.length - 3}</span>
                        )}
                      </div>
                    </div>
                  </article>
                </div>
              ))}
            </div>
          </>
        )}
      </div>
    </div>
  </section>

  <!-- Modal -->
  <div id="project-modal" class="modal">
    <div class="modal-overlay"></div>
    <div class="modal-container">
      <div class="modal-content">
        <button class="modal-close" aria-label="Close modal">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
        <div id="modal-body"></div>
      </div>
    </div>
  </div>
</BaseLayout>

<style>
  /* Override landing section 100vh */
  :global(#landing) {
    height: auto !important;
    min-height: auto !important;
  }

  :global(.landing-container) {
    height: auto !important;
    position: relative !important;
  }

  /* Projects Section */
  #projects-section {
    background: linear-gradient(
        180deg,
        rgba(217, 217, 217, 0.05) 0%,
        rgba(217, 217, 217, 0) 100%
      ),
      linear-gradient(180deg, #000000 0%, #14123c 100%);
    min-height: 100vh;
    position: relative;
  }

  /* Scrolling Container */
  .projects-scroll-container {
    max-height: calc(100vh - 80px);
    overflow-y: auto;
    overflow-x: hidden;
    padding: 4rem 0 6rem 0;
  }

  /* Custom Scrollbar */
  .projects-scroll-container::-webkit-scrollbar {
    width: 8px;
  }

  .projects-scroll-container::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
  }

  .projects-scroll-container::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 4px;
  }

  .projects-scroll-container::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.3);
  }

  /* Page Header */
  .projects-page-header {
    text-align: center;
    margin: 0 auto 4rem auto;
    max-width: 800px;
  }

  .projects-page-header h1 {
    font-family: "Dual-300";
    font-size: 3.5rem;
    color: white;
    margin: 0 0 1rem 0;
    text-align: center;
  }

  .projects-subtitle {
    font-family: "Stellar", "Century Gothic", sans-serif;
    font-size: 1.1rem;
    color: rgba(255, 255, 255, 0.7);
    margin: 0;
    text-align: center;
  }

  /* Projects Grid */
  .projects-grid {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 2rem;
    gap: 2rem 0;
  }

  /* Project Card */
  .project-card {
    background: radial-gradient(
      50% 50% at 50% 50%,
      rgba(255, 255, 255, 0) 0%,
      rgba(255, 255, 255, 0.05) 100%
    );
    box-shadow: inset 0px 5px 10px -5px rgba(255, 255, 255, 0.3),
      inset 0px 0px 40px rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(20px);
    border-radius: 1rem;
    padding: 0;
    overflow: hidden;
    transition: all 0.3s ease;
    border: 1px solid rgba(255, 255, 255, 0.1);
    cursor: pointer;
    margin: 0 1rem;
  }

  .project-card:hover {
    transform: translateY(-6px);
    box-shadow: inset 0px 5px 10px -5px rgba(255, 255, 255, 0.5),
      inset 0px 0px 60px rgba(255, 255, 255, 0.15),
      0px 15px 40px rgba(0, 0, 0, 0.4);
    border-color: rgba(255, 255, 255, 0.3);
  }

  .project-image {
    width: 100%;
    height: 250px;
    object-fit: cover;
    display: block;
  }

  .project-card-content {
    padding: 1.75rem;
  }

  /* Adjust padding when there's no image */
  .project-card:not(:has(.project-image)) .project-card-content {
    padding-top: 2rem;
  }

  .project-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 1rem;
    margin-bottom: 0.75rem;
  }

  .project-title {
    font-family: "Dual-300";
    font-size: 2rem;
    color: white;
    margin: 0;
    line-height: 1.2;
    flex: 1;
    text-align: left;
  }

  .project-badges {
    display: flex;
    gap: 0.5rem;
    flex-shrink: 0;
    flex-wrap: wrap;
  }

  .badge-featured,
  .badge-status {
    display: inline-block;
    padding: 0.35rem 0.75rem;
    border-radius: 0.4rem;
    font-family: "Stellar", "Century Gothic", sans-serif;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .badge-featured {
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.2) 0%, rgba(255, 165, 0, 0.2) 100%);
    border: 1px solid rgba(255, 215, 0, 0.4);
    color: rgba(255, 215, 0, 1);
  }

  .badge-status {
    border: 1px solid rgba(255, 255, 255, 0.2);
  }

  .status-ongoing {
    background: rgba(0, 255, 127, 0.15);
    border-color: rgba(0, 255, 127, 0.4);
    color: rgba(0, 255, 127, 1);
  }

  .status-completed {
    background: rgba(100, 149, 237, 0.15);
    border-color: rgba(100, 149, 237, 0.4);
    color: rgba(100, 149, 237, 1);
  }

  .status-archived {
    background: rgba(169, 169, 169, 0.15);
    border-color: rgba(169, 169, 169, 0.4);
    color: rgba(169, 169, 169, 1);
  }

  .project-role {
    font-family: "Stellar", "Century Gothic", sans-serif;
    font-size: 0.95rem;
    color: rgba(255, 255, 255, 0.85);
    margin: 0 0 1rem 0;
    font-style: italic;
    text-align: left;
  }

  .project-summary {
    font-family: "Stellar", "Century Gothic", sans-serif;
    font-size: 1rem;
    line-height: 1.6;
    color: rgba(255, 255, 255, 0.9);
    margin: 0 0 1.25rem 0;
    text-align: left;
  }

  .project-meta {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1rem;
    font-family: "Stellar", "Century Gothic", sans-serif;
    font-size: 0.85rem;
    color: rgba(255, 255, 255, 0.8);
  }

  .meta-separator {
    color: rgba(255, 255, 255, 0.5);
  }

  .project-tech {
    display: flex;
    flex-wrap: wrap;
    margin-top: 1rem;
    margin-bottom: 0.5rem;
  }

  .tech-tag {
    display: inline-block;
    padding: 0.35rem 0.75rem;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 0.4rem;
    font-family: "Stellar", "Century Gothic", sans-serif;
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.9);
    margin: 0 0.5rem 0.5rem 0;
  }

  .tech-more {
    display: inline-block;
    padding: 0.35rem 0.75rem;
    font-family: "Stellar", "Century Gothic", sans-serif;
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.5);
    font-style: italic;
  }

  /* Section Headers */
  .section-header {
    margin: 3rem auto 2rem auto;
    padding: 0 2rem;
    max-width: 1400px;
  }

  .section-header h2 {
    font-family: "Dual-300";
    font-size: 2.5rem;
    color: white;
    margin: 0;
    text-align: left;
  }

  .minor-header {
    margin-top: 5rem;
  }

  /* Minor Project Cards - Compact Styling */
  .minor-card {
    background: radial-gradient(
      50% 50% at 50% 50%,
      rgba(255, 255, 255, 0) 0%,
      rgba(255, 255, 255, 0.03) 100%
    );
    box-shadow: inset 0px 5px 10px -5px rgba(255, 255, 255, 0.2),
      inset 0px 0px 30px rgba(255, 255, 255, 0.05);
  }

  .minor-card:hover {
    transform: translateY(-4px);
    box-shadow: inset 0px 5px 10px -5px rgba(255, 255, 255, 0.4),
      inset 0px 0px 40px rgba(255, 255, 255, 0.1),
      0px 10px 30px rgba(0, 0, 0, 0.3);
  }

  .minor-image {
    height: 180px;
  }

  .minor-card .project-card-content {
    padding: 1.25rem;
  }

  .minor-title {
    font-size: 1.5rem;
  }

  .minor-role {
    font-size: 0.85rem;
    margin: 0 0 0.75rem 0;
  }

  .minor-card .project-meta {
    margin-bottom: 0.75rem;
    font-size: 0.8rem;
  }

  .minor-card .project-tech {
    margin-top: 0.75rem;
    margin-bottom: 0.5rem;
  }

  .minor-tech-tag {
    font-size: 0.7rem;
    padding: 0.3rem 0.6rem;
    margin: 0 0.4rem 0.4rem 0;
  }

  .minor-card .tech-more {
    font-size: 0.7rem;
    padding: 0.3rem 0.6rem;
  }

  /* Modal */
  .modal {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
  }

  .modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.3);
    backdrop-filter: blur(8px);
  }

  .modal-container {
    position: relative;
    width: 100%;
    height: 100%;
    overflow-y: auto;
    padding: 3% 0;
  }

  .modal-content {
    position: relative;
    background: linear-gradient(
        180deg,
        rgba(217, 217, 217, 0.05) 0%,
        rgba(217, 217, 217, 0) 100%
      ),
      linear-gradient(180deg, #000000 0%, #14123c 100%);
    margin: 0 auto;
    padding: 3rem;
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 1rem;
    width: 90%;
    max-width: 900px;
    box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
  }

  .modal-close {
    position: absolute;
    top: 3rem;
    right: 3rem;
    color: rgba(255, 255, 255, 0.9);
    border: 1px solid rgba(255, 255, 255, 0.3);
    background: rgba(0, 0, 0, 0.6);
    cursor: pointer;
    transition: all 0.3s ease;
    z-index: 10000;
    width: 44px;
    height: 44px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    backdrop-filter: blur(10px);
  }

  .modal-close svg {
    width: 20px;
    height: 20px;
  }

  .modal-close:hover {
    color: white;
    background: rgba(0, 0, 0, 0.9);
    border-color: rgba(255, 255, 255, 0.5);
    transform: scale(1.1);
  }

  /* Modal Content Styles - Inherit from project detail page */
  :global(.modal) :global(.tech-tag) {
    display: inline-block;
    padding: 0.5rem 1rem;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 0.5rem;
    font-family: "Stellar", "Century Gothic", sans-serif;
    font-size: 0.9rem;
    color: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(5px);
    transition: all 0.2s;
    margin: 0 0.75rem 0.75rem 0;
  }

  :global(.modal) :global(.project-tech) {
    margin: 1.25rem 0 1.25rem 0;
  }

  :global(.modal) :global(.project-links) {
    margin: 1.25rem 0 1.25rem 0;
  }

  :global(.modal) :global(.project-link-button) {
    display: inline-flex;
    align-items: center;
    gap: 0.6rem;
    padding: 0.85rem 1.75rem;
    margin-right: 1rem;
    margin-bottom: 0.75rem;
    background: linear-gradient(
      135deg,
      rgba(100, 149, 237, 0.2) 0%,
      rgba(70, 130, 180, 0.15) 100%
    );
    border: 1.5px solid rgba(100, 149, 237, 0.4);
    border-radius: 0.6rem;
    font-family: "Stellar", "Century Gothic", sans-serif;
    font-size: 1rem;
    font-weight: 500;
    color: white !important;
    text-decoration: none;
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
  }

  :global(.modal) :global(.project-link-button:hover) {
    background: linear-gradient(
      135deg,
      rgba(100, 149, 237, 0.3) 0%,
      rgba(70, 130, 180, 0.25) 100%
    );
    border-color: rgba(100, 149, 237, 0.6);
    box-shadow: 0 4px 16px rgba(100, 149, 237, 0.3);
    transform: translateY(-3px);
  }

  :global(.modal) :global(.project-link-button svg) {
    width: 18px;
    height: 18px;
    flex-shrink: 0;
  }

  :global(.modal) :global(.badge-featured),
  :global(.modal) :global(.badge-status) {
    display: inline-block;
    padding: 0.45rem 0.9rem;
    border-radius: 0.5rem;
    font-family: "Stellar", "Century Gothic", sans-serif;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  :global(.modal) :global(.badge-featured) {
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.2) 0%, rgba(255, 165, 0, 0.2) 100%);
    border: 1px solid rgba(255, 215, 0, 0.4);
    color: rgba(255, 215, 0, 1);
  }

  :global(.modal) :global(.status-ongoing) {
    background: rgba(0, 255, 127, 0.15);
    border-color: rgba(0, 255, 127, 0.4);
    color: rgba(0, 255, 127, 1);
  }

  :global(.modal) :global(.status-completed) {
    background: rgba(100, 149, 237, 0.15);
    border-color: rgba(100, 149, 237, 0.4);
    color: rgba(100, 149, 237, 1);
  }

  :global(.modal) :global(.status-archived) {
    background: rgba(169, 169, 169, 0.15);
    border-color: rgba(169, 169, 169, 0.4);
    color: rgba(169, 169, 169, 1);
  }

  /* Fix all text colors in modal */
  :global(.modal) :global(h1),
  :global(.modal) :global(h2),
  :global(.modal) :global(h3),
  :global(.modal) :global(h4),
  :global(.modal) :global(h5),
  :global(.modal) :global(h6) {
    color: white !important;
  }

  :global(.modal) :global(p),
  :global(.modal) :global(span),
  :global(.modal) :global(div),
  :global(.modal) :global(li) {
    color: rgba(255, 255, 255, 0.9) !important;
  }

  :global(.modal) :global(.project-meta-category),
  :global(.modal) :global(.project-meta-duration),
  :global(.modal) :global(.project-role),
  :global(.modal) :global(.meta-separator) {
    color: rgba(255, 255, 255, 0.85) !important;
  }

  :global(.modal) :global(.project-summary) {
    color: rgba(255, 255, 255, 0.95) !important;
  }

  :global(.modal) :global(a) {
    color: rgba(255, 255, 255, 0.95) !important;
  }

  /* Fix image sizes in modal */
  :global(.modal) :global(.gallery-item img),
  :global(.modal) :global(.project-gallery img) {
    width: 100%;
    height: 400px;
    object-fit: cover;
  }

  :global(.modal) :global(.project-content img) {
    max-width: 100%;
    height: auto;
    max-height: 500px;
    object-fit: contain;
  }

  /* Hide back links and summary box in modal */
  :global(.modal) :global(.back-link-container),
  :global(.modal) :global(.back-link-footer-container),
  :global(.modal) :global(.project-summary-box) {
    display: none !important;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .projects-page-header h1 {
      font-size: 2.5rem;
    }

    .projects-grid {
      padding: 0 1rem;
    }

    .project-card {
      margin: 0 0.5rem;
    }

    .project-title {
      font-size: 1.5rem;
    }

    .minor-title {
      font-size: 1.3rem;
    }

    .section-header h2 {
      font-size: 2rem;
    }

    .project-card-header {
      flex-direction: column;
      align-items: flex-start;
    }

    .modal-content {
      width: 95%;
      padding: 2rem;
    }

    .modal-close {
      top: 2rem;
      right: 2rem;
      width: 40px;
      height: 40px;
    }

    .modal-close svg {
      width: 18px;
      height: 18px;
    }
  }
</style>

<script>
  // Modal handling
  const modal = document.getElementById('project-modal');
  const modalBody = document.getElementById('modal-body');
  const closeBtn = document.querySelector('.modal-close');

  // Get all project cards
  const projectCards = document.querySelectorAll('.project-card');

  projectCards.forEach((card) => {
    card.addEventListener('click', async () => {
      const slug = card.getAttribute('data-project-slug');

      if (!slug) return;

      // Fetch project detail page
      try {
        const response = await fetch(`/projects/${slug}/`);
        if (response.ok) {
          const html = await response.text();
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');

          // Extract the content from the detail page
          const detailSection = doc.querySelector('#project-detail-section');

          if (detailSection && modalBody) {
            modalBody.innerHTML = detailSection.innerHTML;
            if (modal) modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
          }
        }
      } catch (error) {
        console.error('Error loading project:', error);
      }
    });
  });

  // Close modal
  closeBtn?.addEventListener('click', () => {
    if (modal) {
      modal.style.display = 'none';
      document.body.style.overflow = '';
    }
  });

  // Close on overlay click (but not on content click)
  const modalOverlay = document.querySelector('.modal-overlay');
  const modalContainer = document.querySelector('.modal-container');

  modalContainer?.addEventListener('click', (event) => {
    // Only close if clicking the container itself, not its children
    if (event.target === modalContainer) {
      if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = '';
      }
    }
  });

  // Close on escape key
  document.addEventListener('keydown', (event) => {
    if (event.key === 'Escape' && modal && modal.style.display === 'block') {
      modal.style.display = 'none';
      document.body.style.overflow = '';
    }
  });
</script>
