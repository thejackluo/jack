---
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import BaseLayout from '../../layouts/Base.astro';
import { calculateReadingTime, formatReadingTime } from '../../utils/reading-time';

export async function getStaticPaths() {
  const blogEntries = await getCollection('blogs');

  // Filter out draft posts
  const draftSlugs = ['three-weeks-in-a-hacker-house', 'jack', 'luo'];
  const publishedBlogs = blogEntries.filter(entry => !draftSlugs.includes(entry.slug));

  return publishedBlogs.map(entry => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

interface Props {
  entry: CollectionEntry<'blogs'>;
}

const { entry } = Astro.props;
const { Content } = await entry.render();
const readingTime = calculateReadingTime(entry.body);

// Format publish date
const publishDate = entry.data.publishDate.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});
---

<BaseLayout
  title={`${entry.data.title} - Jack Luo`}
  description={entry.data.excerpt}
  currentPage="writing"
>
  <article id="blog-post-section">
    <div class="container-fluid">
      <div class="row">
        <div class="col-12">
          <!-- Back Link -->
          <div class="back-link-container">
            <a href="/writing" class="back-link">
              <h5>← Writing</h5>
            </a>
          </div>

          <!-- Blog Header -->
          <header class="blog-header">
            <h2 class="blog-title">{entry.data.title}</h2>

            <div class="blog-meta" data-publish-date="{publishDate}" style="display: none;">
              <span class="blog-meta-date">{publishDate}</span>
            </div>

            <div class="blog-tags">
              {entry.data.tags.map(tag => (
                <a href={`/writing?tag=${tag}`} class="blog-tag">
                  {tag}
                </a>
              ))}
            </div>
          </header>

          <!-- Blog Content -->
          <div class="blog-content">
            <Content />
          </div>

          <!-- Blog Footer -->
          <footer class="blog-footer">
            <div class="blog-footer-divider"></div>

            <div class="blog-footer-content">
              <p>
                Thanks for reading! Feel free to <a href="mailto:jack@hexahacks.com" class="a-underline">reach out</a> with your thoughts.
              </p>
            </div>

            <div class="back-link-footer-container">
              <a href="/writing" class="back-link-footer">
                <h5>← Back to all posts</h5>
              </a>
            </div>
          </footer>
        </div>
      </div>
    </div>
  </article>
</BaseLayout>

<style>
  /* Link to existing CSS files */
  @import url('/src/css/writing.css');
  @import url('/src/css/blog.css');

  /* Hide the default landing section for blog pages */
  :global(#landing) {
    height: auto !important;
    min-height: auto !important;
  }

  :global(.landing-container) {
    height: auto !important;
    position: relative !important;
  }

  /* Blog Post Section */
  #blog-post-section {
    background: linear-gradient(
        180deg,
        rgba(217, 217, 217, 0.05) 0%,
        rgba(217, 217, 217, 0) 100%
      ),
      linear-gradient(180deg, #000000 0%, #14123c 100%);
    min-height: 100vh;
    padding: 2rem 0 5rem 0;
  }

  /* Back Link Container */
  .back-link-container {
    max-width: 800px;
    margin: 0 auto 2rem auto;
    padding: 0 1rem;
  }

  .back-link {
    text-decoration: none;
    display: inline-block;
    transition: all 0.3s ease;
  }

  .back-link h5 {
    color: rgba(255, 255, 255, 0.8);
    text-align: left;
    margin: 0;
  }

  .back-link:hover h5 {
    color: white;
    text-shadow: 0px 0px 20px rgba(255, 255, 255, 0.6);
  }

  /* Blog Header */
  .blog-header {
    max-width: 800px;
    margin: 0 auto 3rem auto;
    padding: 0 1rem;
  }

  .blog-title {
    font-family: "Dual-300";
    font-size: 2.5rem;
    color: white;
    margin-bottom: 1.5rem;
    line-height: 1.2;
    text-align: left;
    display: block;
  }

  .blog-meta {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
  }

  .blog-meta-date,
  .blog-meta-reading {
    font-family: "Stellar", "Century Gothic", sans-serif;
    font-size: 1rem;
    color: rgba(255, 255, 255, 0.6);
  }

  .meta-separator {
    color: rgba(255, 255, 255, 0.3);
    font-family: "Stellar", "Century Gothic", sans-serif;
  }

  .blog-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .blog-tag {
    display: inline-block;
    padding: 0.4rem 0.9rem;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 0.5rem;
    font-family: "Stellar", "Century Gothic", sans-serif;
    font-size: 0.85rem;
    color: rgba(255, 255, 255, 0.9);
    text-decoration: none;
    backdrop-filter: blur(5px);
    transition: all 0.2s;
  }

  .blog-tag:hover {
    background: rgba(255, 255, 255, 0.15);
    border-color: rgba(255, 255, 255, 0.3);
    text-shadow: 0px 0px 10px rgba(255, 255, 255, 0.5);
  }

  /* Blog Content Styles */
  .blog-content {
    max-width: 800px;
    margin: 0 auto;
    padding: 0 1rem;
    font-family: "Stellar", "Century Gothic", sans-serif;
    font-size: 1.125rem;
    line-height: 1.8;
    color: rgba(255, 255, 255, 0.9);
  }

  /* Typography */
  .blog-content :global(h1),
  .blog-content :global(h2),
  .blog-content :global(h3),
  .blog-content :global(h4),
  .blog-content :global(h5),
  .blog-content :global(h6) {
    font-family: "Dual-300";
    font-weight: 600;
    line-height: 1.3;
    margin-top: 2.5rem;
    margin-bottom: 1rem;
    color: white;
    text-align: left;
    display: block;
  }

  /* First heading has less top margin */
  .blog-content :global(h1:first-of-type),
  .blog-content :global(h2:first-of-type),
  .blog-content :global(h3:first-of-type) {
    margin-top: 1rem;
  }

  .blog-content :global(h1) {
    font-size: 2rem;
    font-weight: 700;
  }

  .blog-content :global(h2) {
    font-size: 2.25rem;
    font-weight: 600;
  }

  .blog-content :global(h3) {
    font-size: 1.5rem;
    font-weight: 600;
  }

  .blog-content :global(h4) {
    font-size: 1.25rem;
    font-weight: 600;
  }

  .blog-content :global(h5) {
    font-size: 1.1rem;
    font-weight: 600;
  }

  .blog-content :global(h6) {
    font-size: 1rem;
    font-weight: 600;
  }

  .blog-content :global(p) {
    margin-bottom: 1.5rem;
    color: rgba(255, 255, 255, 0.85);
    text-align: left;
  }

  .blog-content :global(strong),
  .blog-content :global(b) {
    font-weight: 700;
    color: rgba(255, 255, 255, 0.95);
  }

  .blog-content :global(em),
  .blog-content :global(i) {
    font-style: italic;
  }

  /* Links */
  .blog-content :global(a) {
    color: rgba(255, 255, 255, 0.9);
    text-decoration: underline;
    transition: all 0.2s;
  }

  .blog-content :global(a:hover) {
    color: white;
    text-shadow: 0px 0px 10px rgba(255, 255, 255, 0.6);
  }

  /* Lists */
  .blog-content :global(ul),
  .blog-content :global(ol) {
    margin-bottom: 1.5rem;
    padding-left: 2rem;
  }

  .blog-content :global(li) {
    margin-bottom: 0.75rem;
    line-height: 1.7;
    color: rgba(255, 255, 255, 0.85);
  }

  .blog-content :global(ul) {
    list-style-type: disc;
  }

  .blog-content :global(ol) {
    list-style-type: decimal;
  }

  .blog-content :global(ul ul),
  .blog-content :global(ol ol),
  .blog-content :global(ul ol),
  .blog-content :global(ol ul) {
    margin-top: 0.5rem;
    margin-bottom: 0.5rem;
  }

  /* Blockquotes */
  .blog-content :global(blockquote) {
    border-left: 4px solid rgba(255, 255, 255, 0.4);
    padding-left: 1.5rem;
    margin: 2rem 0;
    font-style: italic;
    color: rgba(255, 255, 255, 0.7);
  }

  .blog-content :global(blockquote p) {
    margin-bottom: 0.5rem;
  }

  /* Code */
  .blog-content :global(code) {
    background: rgba(255, 255, 255, 0.1);
    padding: 0.2em 0.4em;
    border-radius: 3px;
    font-family: 'Courier New', Courier, monospace;
    font-size: 0.9em;
    color: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.2);
  }

  .blog-content :global(pre) {
    background: rgba(0, 0, 0, 0.5);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: rgba(255, 255, 255, 0.9);
    padding: 1.5rem;
    border-radius: 8px;
    overflow-x: auto;
    margin: 2rem 0;
  }

  .blog-content :global(pre code) {
    background: none;
    padding: 0;
    border: none;
    color: inherit;
    font-size: 0.9rem;
  }

  /* Images */
  .blog-content :global(img) {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    margin: 2rem 0;
    display: block;
    filter: drop-shadow(0px 0px 20px rgba(255, 255, 255, 0.1));
  }

  /* Author Meta Section (Medium-style) */
  /* Wrapper for author section - first two elements when first is an image */
  .blog-content:has(> :global(p:first-child img)) {
    display: block;
  }

  /* First paragraph containing author image */
  .blog-content > :global(p:first-child:has(img)) {
    display: inline-block;
    vertical-align: top;
    margin: 0 1rem 2.5rem 0;
    width: auto;
  }

  .blog-content > :global(p:first-child:has(img) + blockquote) {
    display: inline-block;
    vertical-align: top;
    border: none;
    padding: 0;
    margin: 0 0 2.5rem 0;
    font-style: normal;
    max-width: calc(100% - 88px);
  }

  .blog-content > :global(p:first-child img) {
    width: 72px;
    height: 72px;
    border-radius: 50%;
    margin: 0;
    display: block;
    filter: drop-shadow(0px 2px 8px rgba(255, 255, 255, 0.2));
  }

  .blog-content > :global(p:first-child:has(img) + blockquote p) {
    margin: 0;
    padding: 0.5rem 0;
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.95rem;
  }

  .blog-content > :global(p:first-child:has(img) + blockquote em) {
    font-style: normal;
  }

  /* Author date styling */
  .blog-content > :global(p:first-child:has(img) + blockquote .author-date) {
    margin-top: 0.25rem;
    padding: 0.25rem 0;
    color: rgba(255, 255, 255, 0.6);
    font-size: 0.9rem;
  }

  /* When blog doesn't have author image, style blockquote normally */
  .blog-content > :global(blockquote:first-child) {
    border-left: 4px solid rgba(255, 255, 255, 0.4);
    padding-left: 1.5rem;
    margin: 0 0 2.5rem 0;
    font-style: normal;
  }

  .blog-content > :global(blockquote:first-child p) {
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.95rem;
  }

  .blog-content > :global(blockquote:first-child em) {
    font-style: normal;
  }

  .blog-content > :global(blockquote:first-child .author-date) {
    margin-top: 0.25rem;
    padding: 0.25rem 0;
    color: rgba(255, 255, 255, 0.6);
    font-size: 0.9rem;
  }

  /* Horizontal Rule */
  .blog-content :global(hr) {
    border: none;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    margin: 3rem 0;
  }

  /* Tables */
  .blog-content :global(table) {
    width: 100%;
    border-collapse: collapse;
    margin: 2rem 0;
  }

  .blog-content :global(th),
  .blog-content :global(td) {
    padding: 0.75rem;
    border: 1px solid rgba(255, 255, 255, 0.2);
    text-align: left;
    color: rgba(255, 255, 255, 0.85);
  }

  .blog-content :global(th) {
    background: rgba(255, 255, 255, 0.1);
    font-weight: bold;
    color: white;
  }

  /* Blog Footer */
  .blog-footer {
    max-width: 800px;
    margin: 4rem auto 0 auto;
    padding: 0 1rem;
  }

  .blog-footer-divider {
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    margin-bottom: 2rem;
  }

  .blog-footer-content {
    text-align: center;
    margin-bottom: 2rem;
  }

  .blog-footer-content p {
    font-family: "Stellar", "Century Gothic", sans-serif;
    font-size: 1rem;
    color: rgba(255, 255, 255, 0.7);
  }

  .back-link-footer-container {
    text-align: center;
  }

  .back-link-footer {
    text-decoration: none;
    display: inline-block;
    transition: all 0.3s ease;
  }

  .back-link-footer h5 {
    color: rgba(255, 255, 255, 0.8);
  }

  .back-link-footer:hover h5 {
    color: white;
    text-shadow: 0px 0px 20px rgba(255, 255, 255, 0.6);
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    #blog-post-section {
      padding: 2rem 0 4rem 0;
    }

    .blog-title {
      font-size: 2rem;
    }

    .blog-content {
      font-size: 1.05rem;
    }

    .blog-content :global(h1) {
      font-size: 1.75rem;
    }

    .blog-content :global(h2) {
      font-size: 2rem;
    }

    .blog-content :global(h3) {
      font-size: 1.25rem;
    }
  }

  @media (max-width: 576px) {
    .blog-title {
      font-size: 1.75rem;
    }

    .blog-content {
      font-size: 1rem;
    }

    .blog-meta {
      font-size: 0.9rem;
    }
  }
</style>

<script>
  // Remove citation markers from the rendered content
  function cleanCitationMarkers() {
    const blogContent = document.querySelector('.blog-content');
    if (blogContent) {
      // Remove citation markers like 【772938094626183†L36-L39】
      const walker = document.createTreeWalker(
        blogContent,
        NodeFilter.SHOW_TEXT,
        null
      );

      const nodesToUpdate: { node: Text; newValue: string }[] = [];

      let node: Text | null;
      while ((node = walker.nextNode() as Text | null)) {
        if (node.nodeValue) {
          const cleaned = node.nodeValue.replace(/【[^】]*】/g, '');
          if (cleaned !== node.nodeValue) {
            nodesToUpdate.push({ node, newValue: cleaned });
          }
        }
      }

      // Update nodes after walking to avoid iterator issues
      nodesToUpdate.forEach(({ node, newValue }) => {
        node.nodeValue = newValue;
      });
    }
  }

  // Move the publish date to the author section
  function movePublishDate() {
    const blogMeta = document.querySelector('.blog-meta');
    const blogContent = document.querySelector('.blog-content');

    if (!blogMeta || !blogContent) return;

    const publishDate = blogMeta.getAttribute('data-publish-date');
    if (!publishDate) return;

    // Find the author blockquote (first blockquote that follows a paragraph with an image)
    const firstParagraph = blogContent.querySelector('p:first-child');
    const hasImage = firstParagraph?.querySelector('img');

    if (hasImage) {
      const authorBlockquote = blogContent.querySelector('p:first-child + blockquote');
      if (authorBlockquote) {
        // Add the date as a new paragraph in the blockquote
        const dateParagraph = document.createElement('p');
        dateParagraph.className = 'author-date';
        dateParagraph.textContent = publishDate;
        authorBlockquote.appendChild(dateParagraph);
      }
    } else {
      // If no author image, check if first element is blockquote
      const firstBlockquote = blogContent.querySelector('blockquote:first-child');
      if (firstBlockquote) {
        const dateParagraph = document.createElement('p');
        dateParagraph.className = 'author-date';
        dateParagraph.textContent = publishDate;
        firstBlockquote.appendChild(dateParagraph);
      }
    }
  }

  // Run on page load
  cleanCitationMarkers();
  movePublishDate();
</script>
